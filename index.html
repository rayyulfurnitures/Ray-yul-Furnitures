<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ray-Yul Furniture</title>
    <link rel="icon" href="images/logo.png" type="image/png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBO7elH2BDo48m7wu1CCEh-ZIT-5i1EeUc",
            authDomain: "ray-yul-furniture.firebaseapp.com",
            projectId: "ray-yul-furniture",
            storageBucket: "ray-yul-furniture.appspot.com",
            messagingSenderId: "1009800722761",
            appId: "1:1009800722761:web:258966e71e86dd9db40298",
            measurementId: "G-F93Z8VX82E"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
    </script>
    <style>
        .category-highlight {
            animation: highlight-category 1s;
        }

        @keyframes highlight-category {
            0% {
                background: #e0e7ff;
            }

            100% {
                background: transparent;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow">
        <nav class="container mx-auto flex items-center justify-between py-2 px-2 sm:py-4 sm:px-4 relative">
            <div class="flex items-center space-x-2 sm:space-x-3 min-w-0">
                <img src="images/logo.png" alt="Ray-Yul Logo" class="h-8 w-8 sm:h-14 sm:w-14 object-contain">
                <h1 class="text-sm sm:text-xl md:text-2xl font-bold text-indigo-700 whitespace-nowrap">Ray-Yul Furniture
                </h1>
            </div>
            <!-- Hamburger Icon (mobile only) -->
            <button id="nav-toggle" class="sm:hidden p-2 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg class="w-7 h-7 text-indigo-700" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <!-- Nav Links -->
            <div id="nav-menu"
                class="hidden sm:block absolute sm:static top-full left-0 w-full sm:w-auto bg-white sm:bg-transparent z-50 shadow sm:shadow-none">
                <ul
                    class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-6 text-base py-2 sm:py-0">
                    <li><a href="index.html" class="hover:text-indigo-600 font-semibold block px-4 py-2 sm:p-0">Home</a>
                    </li>
                    <li><a href="about.html" class="hover:text-indigo-600 font-semibold block px-4 py-2 sm:p-0">About
                            Us</a></li>
                    <li><a href="bookings.html"
                            class="hover:text-indigo-600 font-semibold block px-4 py-2 sm:p-0">Bookings</a></li>
                    <li>
                        <a href="#" id="login-btn"
                            class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded hover:bg-indigo-700 transition block text-center w-full md:w-auto">
                            Login
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="bg-indigo-100 py-4 sm:py-8 md:py-12 relative">
        <div class="container mx-auto px-1 sm:px-4 flex flex-col items-center">
            <div id="carousel"
                class="relative w-full max-w-xs sm:max-w-md md:max-w-2xl h-40 sm:h-56 md:h-72 overflow-hidden rounded-lg shadow-lg bg-white group">
                <!-- Slides -->
                <div
                    class="carousel-slide absolute inset-0 flex items-center justify-center transition-opacity duration-1000 opacity-100">
                    <img src="images/sofa.webp" alt="Showroom" class="w-full h-full object-cover rounded-lg">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        <div class="bg-white/40 backdrop-blur-md rounded-lg p-2 sm:p-4 md:p-6 text-center">
                            <h2 class="text-base sm:text-lg md:text-2xl font-bold mb-1 sm:mb-2 text-indigo-700">Discover
                                Quality Furniture for Your Home</h2>
                            <p class="text-gray-700 text-xs sm:text-sm md:text-base">Browse our exclusive collection and
                                book your favorite pieces today!</p>
                        </div>
                    </div>
                </div>
                <div
                    class="carousel-slide absolute inset-0 flex items-center justify-center transition-opacity duration-1000 opacity-0">
                    <img src="images/table.jpg" alt="Woodwork" class="w-full h-full object-cover rounded-lg">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        <div class="bg-white/40 backdrop-blur-md rounded-lg p-2 sm:p-4 md:p-6 text-center">
                            <h2 class="text-base sm:text-lg md:text-2xl font-bold mb-1 sm:mb-2 text-indigo-700">
                                Handcrafted Excellence</h2>
                            <p class="text-gray-700 text-xs sm:text-sm md:text-base">Every piece is crafted with care by
                                skilled artisans using quality materials.</p>
                        </div>
                    </div>
                </div>
                <div
                    class="carousel-slide absolute inset-0 flex items-center justify-center transition-opacity duration-1000 opacity-0">
                    <img src="images/wardrobe.webp" alt="Community" class="w-full h-full object-cover rounded-lg">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        <div class="bg-white/40 backdrop-blur-md rounded-lg p-2 sm:p-4 md:p-6 text-center">
                            <h2 class="text-base sm:text-lg md:text-2xl font-bold mb-1 sm:mb-2 text-indigo-700">Serving
                                Bhutan</h2>
                            <p class="text-gray-700 text-xs sm:text-sm md:text-base">Proudly furnishing homes and
                                offices across the country.</p>
                        </div>
                    </div>
                </div>
                <!-- Carousel Controls -->
                <button id="carousel-prev"
                    class="absolute left-1 sm:left-2 top-1/2 -translate-y-1/2 bg-white bg-opacity-70 rounded-full p-1 sm:p-2 shadow hover:bg-indigo-200 transition z-10">
                    <svg class="w-4 h-4 sm:w-6 sm:h-6 text-indigo-700" fill="none" stroke="currentColor"
                        stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="carousel-next"
                    class="absolute right-1 sm:right-2 top-1/2 -translate-y-1/2 bg-white bg-opacity-70 rounded-full p-1 sm:p-2 shadow hover:bg-indigo-200 transition z-10">
                    <svg class="w-4 h-4 sm:w-6 sm:h-6 text-indigo-700" fill="none" stroke="currentColor"
                        stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <!-- Carousel Dots -->
            <div class="flex space-x-1 sm:space-x-2 mt-2 sm:mt-4">
                <span class="carousel-dot w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-indigo-400 cursor-pointer"></span>
                <span class="carousel-dot w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-indigo-200 cursor-pointer"></span>
                <span class="carousel-dot w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-indigo-200 cursor-pointer"></span>
            </div>
        </div>
    </section>

    <!-- Furniture Catalog Placeholder -->
    <main>
        <section id="catalog" class="container mx-auto px-4 py-10">
            <h2 class="text-2xl font-bold mb-6 text-center">Furniture Collection</h2>
            <!-- Admin Add Furniture Button -->
            <div id="admin-controls" class="mb-6 text-right hidden">
                <button id="add-furniture-btn"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                    + Add Furniture
                </button>
            </div>
            <!-- Insert Furniture Form (Admin) -->
            <div id="insert-furniture" class="mb-6">
                <form id="insert-furniture-form" class="space-x-2">
                    <input type="text" id="insert-name" placeholder="Name" required class="border rounded px-2 py-1">
                    <input type="number" id="insert-price" placeholder="Price" required
                        class="border rounded px-2 py-1">
                    <input type="number" id="insert-stock" placeholder="Stock" required
                        class="border rounded px-2 py-1">
                    <input type="text" id="insert-image" placeholder="Image filename (e.g., chair.jpg)" required
                        class="border rounded px-2 py-1">
                    <select id="insert-category" required class="border rounded px-2 py-1">
                        <option value="">Select Category</option>
                        <option value="Showcase">Showcase</option>
                        <option value="Sofa">Sofa</option>
                        <option value="Wardrobe">Wardrobe</option>
                        <option value="TV Stand">TV Stand</option>
                        <option value="Shoe Rack">Shoe Rack</option>
                        <option value="Bed">Bed</option>
                        <option value="Choesham">Choesham</option>
                        <option value="Table">Table</option> <!-- Added -->
                        <option value="Bookshelf">Bookshelf</option> <!-- Added -->
                    </select>
                    <button type="submit" class="bg-green-600 text-white px-4 py-1 rounded">Insert</button>
                </form>
            </div>

            <!-- Category Navigation Buttons (Sticky) -->
            <div
                class="sticky top-0 z-30 bg-gray-50 py-2 flex flex-wrap gap-2 justify-center shadow-lg border-b border-indigo-100">
                <button onclick="scrollToCategory('Showcase')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Showcase</button>
                <button onclick="scrollToCategory('Sofa')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Sofa</button>
                <button onclick="scrollToCategory('Wardrobe')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Wardrobe</button>
                <button onclick="scrollToCategory('TV Stand')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">TV
                    Stand</button>
                <button onclick="scrollToCategory('Shoe Rack')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Shoe
                    Rack</button>
                <button onclick="scrollToCategory('Bed')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Bed</button>
                <button onclick="scrollToCategory('Choesham')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Choesham</button>
                <button onclick="scrollToCategory('Table')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Table</button>
                <button onclick="scrollToCategory('Bookshelf')"
                    class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">Bookshelf</button>
            </div>


            <!-- Furniture List -->
            <div id="furniture-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 mt-8">
                <!-- Furniture items will be dynamically loaded here -->
            </div>


        </section>
    </main>

    <!-- Add Furniture Modal -->
    <div id="add-furniture-modal"
        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Add New Furniture</h3>
            <form id="furniture-form" class="space-y-4">
                <input type="text" id="furniture-name" placeholder="Name" class="w-full border rounded px-3 py-2"
                    required>
                <input type="number" id="furniture-price" placeholder="Price" class="w-full border rounded px-3 py-2"
                    required>
                <input type="number" id="furniture-stock" placeholder="Stock" class="w-full border rounded px-3 py-2"
                    required>
                <input type="file" id="furniture-image" accept="image/*" class="w-full">
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-modal"
                        class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4" id="auth-title">Login</h3>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" class="w-full border rounded px-3 py-2"
                    required>
                <input type="password" id="auth-password" placeholder="Password" class="w-full border rounded px-3 py-2"
                    required>
                <div id="password-strength" class="h-2 rounded bg-gray-200 mt-1">
                    <div id="password-strength-bar" class="h-2 rounded transition-all duration-300"></div>
                </div>
                <div id="password-strength-text" class="text-xs mt-1"></div>
                <div class="flex justify-between">
                    <button type="submit" id="auth-submit"
                        class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Login</button>
                    <button type="button" id="toggle-auth" class="text-indigo-600 hover:underline">Sign Up</button>
                </div>
                <button type="button" id="forgot-password"
                    class="text-sm text-indigo-600 hover:underline w-full text-left mt-2">Forgot Password?</button>
            </form>
            <button id="close-auth" class="mt-4 text-gray-500 hover:underline w-full">Close</button>
            <div id="auth-error" class="text-red-500 mt-2"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Edit Furniture</h3>
            <form id="edit-form" class="space-y-4">
                <input type="number" id="edit-price" placeholder="Price" class="w-full border rounded px-3 py-2"
                    required>
                <input type="number" id="edit-stock" placeholder="Stock" class="w-full border rounded px-3 py-2"
                    required>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-edit"
                        class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order/Preorder Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4" id="order-modal-title">Order</h3>
            <form id="order-form" class="space-y-4">
                <input type="text" id="order-fullname" placeholder="Full Name" class="w-full border rounded px-3 py-2"
                    required>
                <input type="text" id="order-mobile" placeholder="Mobile Number" class="w-full border rounded px-3 py-2"
                    required>

                <label for="order-address" class="block text-sm text-gray-600">Delivery Location</label>
                <select id="order-address" class="w-full border rounded px-3 py-2" required
                    onchange="toggleOtherLocation(this)">
                    <option value="" disabled selected>Select free delivery location</option>
                    <option value="Chukha">Chukha</option>
                    <option value="Gelephu (Sarpang)">Gelephu (Sarpang)</option>
                    <option value="Haa">Haa</option>
                    <option value="Lhamoizingkha (Dagana)">Lhamoizingkha (Dagana)</option>
                    <option value="Mongar">Mongar</option>
                    <option value="Paro">Paro</option>
                    <option value="Pema Gatshel">Pema Gatshel</option>
                    <option value="Punakha">Punakha</option>
                    <option value="S/Jongkhar">S/Jongkhar</option>
                    <option value="Samtse">Samtse</option>
                    <option value="Tashigang">Tashigang</option>
                    <option value="Thimphu">Thimphu</option>
                    <option value="Wangdue Phodrang">Wangdue Phodrang</option>
                    <option value="other">Other (Specify below)</option>
                </select>
                <input type="text" id="order-other-location" placeholder="If not listed, specify your location"
                    class="w-full border rounded px-3 py-2 mt-2 hidden">

                <input type="number" id="order-quantity" placeholder="Quantity" min="1"
                    class="w-full border rounded px-3 py-2" required>

                <!-- Account Info Section (added, one line, copyable account number) -->
                <div class="flex items-center mb-2 space-x-3 text-xs">
                    <div class="flex items-center">
                        <label class="text-gray-600 mr-1">Account Number:</label>
                        <span id="account-number" class="font-semibold text-indigo-700 select-all cursor-pointer" title="Click to copy">201800123701 (BDBL)</span>
                        <button type="button" onclick="copyAccountNumber()" class="ml-2 px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300 focus:outline-none" title="Copy">
                            Copy
                        </button>
                    </div>
                    <div>
                        <label class="text-gray-600 mr-1">Account Holder:</label>
                        <span class="font-semibold text-indigo-700">Ray-Yul Furniture</span>
                    </div>
                </div>

                <!-- Advance Payment Section -->
                <div id="advance-section" class="mb-2">
                    <div class="text-sm text-indigo-700 font-semibold mb-1">
                        Advance Payment (40%): <span id="advance-amount">Nu.0</span>
                    </div>
                    <input type="text" id="order-journal" placeholder="Journal Number for Advance Payment"
                        class="w-full border rounded px-3 py-2" required>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-order"
                        class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Spinner Overlay -->
    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600 border-b-4 border-white"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div id="toast-content" class="px-6 py-3 rounded shadow text-white text-center"></div>
    </div>

    <!-- Contact Form Section -->
    <section class="container mx-auto px-4 py-10 max-w-md">
        <h2 class="text-2xl font-bold mb-4 text-center">Contact Us</h2>
        <form id="contact-form" class="bg-white rounded shadow p-6 space-y-4">
            <input type="text" id="contact-name" placeholder="Your Name" class="w-full border rounded px-3 py-2"
                required>
            <input type="email" id="contact-email" placeholder="Your Email" class="w-full border rounded px-3 py-2"
                required>
            <textarea id="contact-message" placeholder="Your Message" class="w-full border rounded px-3 py-2" rows="4"
                required></textarea>
            <button type="submit"
                class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">Send
                Message</button>
        </form>
    </section>

    <!-- Admin Contact Messages Section (hidden for non-admins) -->
    <section id="admin-messages" class="container mx-auto px-4 py-10 max-w-2xl hidden">
        <h2 class="text-2xl font-bold mb-4 text-center">Contact Messages</h2>
        <div id="messages-list" class="space-y-4"></div>
    </section>

    <!-- Footer -->
    <footer class="bg-white border-t mt-auto">
        <div class="container mx-auto px-4 py-6 text-center text-gray-500">
            &copy; 2025 Ray-Yul Furniture. All rights reserved.
        </div>
    </footer>

    <!-- Place your <script> block here, just before </body> -->
    <script>
        const adminEmails = ["rayyulfurniture2023@gmail.com"]; // Replace with your admin email(s)
        let isAdminGlobal = false; // <-- Global admin state

        // Fetch and display furniture
        async function fetchFurniture(isAdmin) {
            const snapshot = await db.collection('furnitures').get();
            const furnitures = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFurniture(furnitures, isAdmin);
        }

        // Example: Render furniture cards with edit options for admin
        function renderFurniture(furnitures, isAdmin) {
            const list = document.getElementById('furniture-list');
            list.innerHTML = '';

            // Group by category
            const categories = [
                "Showcase", "Sofa", "Wardrobe", "TV Stand", "Shoe Rack", "Bed", "Choesham", "Table", "Bookshelf"
            ];
            const grouped = {};
            categories.forEach(cat => grouped[cat] = []);
            furnitures.forEach(item => {
                const cat = item.category ? item.category : "Other";
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });

            categories.forEach(cat => {
                if (grouped[cat] && grouped[cat].length > 0) {
                    // Category Title with ID for anchor navigation
                    const catTitle = document.createElement('h3');
                    catTitle.textContent = cat;
                    catTitle.id = `cat-${cat.replace(/\s+/g, '-')}`; // e.g., cat-Wardrobe
                    catTitle.className = "text-xl font-bold mb-4 mt-8 col-span-full text-indigo-700";
                    list.appendChild(catTitle);

                    // Furniture cards
                    grouped[cat].forEach(item => {
                        const card = document.createElement('div');
                        card.className = "bg-white rounded shadow p-4 flex flex-col items-center";
                        card.innerHTML = `
  <div class="w-full rounded mb-4 flex items-center justify-center overflow-hidden" style="min-height:120px; background-color:rgba(229,231,235,0.15);">
    <img src="images/${item.image}" alt="${item.name}" class="max-h-64 w-auto object-contain rounded" style="display:block; margin:auto;">
  </div>
  <h3 class="font-semibold text-lg mb-2 text-center" style="min-height:2.5rem; display:flex; align-items:center; justify-content:center;">${item.name}</h3>
  <span class="font-bold text-indigo-700 mb-2">Nu.${item.price}</span>
  <span class="mb-2 text-sm text-gray-500 stock-value" id="stock-${item.id}">
    Stock: ${item.stock}
    ${isAdmin && Number(item.stock) <= 2 ? '<span class="text-red-600 font-bold ml-2">(Low!)</span>' : ''}
  </span>
  ${isAdmin
                                ? `
<button onclick="showEditModal('${item.id}', ${item.price}, ${item.stock})" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition mt-2">Edit</button>
<button onclick="removeFurniture('${item.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition mt-2 ml-2">Remove</button>
`
                                : `
<button onclick="openOrderModal('${item.id}', '${item.name}', ${item.stock})"
  class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition mt-2">
  ${item.stock > 0 ? "Book Now" : "Pre-order"}
</button>
`
                            }
`;
                        list.appendChild(card);
                    });
                }
            });
        }

        // Modal logic
        const modal = document.getElementById('add-furniture-modal');
        document.getElementById('add-furniture-btn').onclick = () => modal.classList.remove('hidden');
        document.getElementById('cancel-modal').onclick = () => modal.classList.add('hidden');

        // Handle form submit
        document.getElementById('furniture-form').onsubmit = async function (e) {
            e.preventDefault();
            const name = document.getElementById('furniture-name').value;
            const price = document.getElementById('furniture-price').value;
            const stock = document.getElementById('furniture-stock').value;
            const imageInput = document.getElementById('furniture-image');
            let imageURL = '';

            if (imageInput.files && imageInput.files[0]) {
                // 1. Upload image to Firebase Storage
                const file = imageInput.files[0];
                const storageRef = storage.ref().child('furnitures/' + Date.now() + '_' + file.name);
                await storageRef.put(file);
                imageURL = await storageRef.getDownloadURL();
            }

            // 2. Save furniture data to Firestore
            await db.collection('furnitures').add({
                name,
                price,
                stock,
                image: imageURL
            });

            // 3. Refresh catalog
            fetchFurniture(isAdminGlobal);
            modal.classList.add('hidden');
            e.target.reset();
        };

        document.getElementById('insert-furniture-form').onsubmit = async function (e) {
            e.preventDefault();
            const name = document.getElementById('insert-name').value;
            const price = Number(document.getElementById('insert-price').value);
            const stock = Number(document.getElementById('insert-stock').value);
            const image = document.getElementById('insert-image').value;
            const category = document.getElementById('insert-category').value; // <-- Add this line

            await db.collection('furnitures').add({ name, price, stock, image, category }); // <-- Add category here
            alert("Furniture inserted!");
            this.reset();
            fetchFurniture(isAdminGlobal);
        };

        let currentEditId = null;

        function showEditModal(id, price, stock) {
            currentEditId = id;
            document.getElementById('edit-price').value = price;
            document.getElementById('edit-stock').value = stock;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        document.getElementById('cancel-edit').onclick = () => {
            document.getElementById('edit-modal').classList.add('hidden');
        };

        document.getElementById('edit-form').onsubmit = async function (e) {
            e.preventDefault();
            const newPrice = document.getElementById('edit-price').value;
            const newStock = document.getElementById('edit-stock').value;
            if (!currentEditId) return;

            // Update Firestore
            await db.collection('furnitures').doc(currentEditId).update({
                price: Number(newPrice),
                stock: Number(newStock)
            });

            document.getElementById('edit-modal').classList.add('hidden');
            fetchFurniture(isAdminGlobal);
        };

        // Login/Signup logic
        const loginBtn = document.getElementById('login-btn');
        const authModal = document.getElementById('auth-modal');
        const closeAuth = document.getElementById('close-auth');
        const toggleAuth = document.getElementById('toggle-auth');
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const authSubmit = document.getElementById('auth-submit');

        let isLogin = true;

        // Auth state listener
        firebase.auth().onAuthStateChanged(user => {
            let isAdmin = false;
            if (user && adminEmails.includes(user.email)) {
                isAdmin = true;
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('insert-furniture').classList.remove('hidden');
                // Show messages section and fetch messages
                document.getElementById('admin-messages').classList.remove('hidden');
                fetchContactMessages();
            } else {
                document.getElementById('admin-controls').classList.add('hidden');
                document.getElementById('insert-furniture').classList.add('hidden');
                // Hide messages section for non-admins
                document.getElementById('admin-messages').classList.add('hidden');
            }
            isAdminGlobal = isAdmin; // Set global state
            loginBtn.textContent = user ? "Logout" : "Login";
            loginBtn.onclick = (e) => {
                e.preventDefault();
                if (user) {
                    firebase.auth().signOut().then(() => {
                        window.location.href = "index.html";
                    });
                } else {
                    authModal.classList.remove('hidden');
                    isLogin = true;
                    authTitle.textContent = "Login";
                    toggleAuth.textContent = "Sign Up";
                    authSubmit.textContent = "Login";
                    authError.textContent = "";
                }
            };

            authModal.classList.add('hidden');
            fetchFurniture(isAdminGlobal);
        });

        closeAuth.onclick = () => authModal.classList.add('hidden');

        toggleAuth.onclick = () => {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? "Login" : "Sign Up";
            toggleAuth.textContent = isLogin ? "Sign Up" : "Login";
            authSubmit.textContent = isLogin ? "Login" : "Sign Up";
            authError.textContent = "";
            // Show forgot password only in Login mode
            forgotPasswordBtn.classList.toggle('hidden', !isLogin);

            // Show strength meter only in Sign Up mode
            if (isLogin) {
                passwordStrengthDiv.style.display = "none";
                passwordStrengthText.style.display = "none";
            } else {
                passwordStrengthDiv.style.display = "block";
                passwordStrengthText.style.display = "block";
            }
        };

        // Always show forgot password in Login mode on modal open
        loginBtn.onclick = (e) => {
            e.preventDefault();
            authModal.classList.remove('hidden');
            isLogin = true;
            authTitle.textContent = "Login";
            toggleAuth.textContent = "Sign Up";
            authSubmit.textContent = "Login";
            authError.textContent = "";
            forgotPasswordBtn.classList.remove('hidden');
            passwordStrengthDiv.style.display = "none";
            passwordStrengthText.style.display = "none";
        };

        authForm.onsubmit = async (e) => {
            e.preventDefault();
            showSpinner();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            authError.textContent = "";
            try {
                if (isLogin) {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                    showToast("Login successful!", "success");
                } else {
                    await firebase.auth().createUserWithEmailAndPassword(email, password);
                    showToast("Signup successful!", "success");
                }
            } catch (err) {
                authError.textContent = err.message;
                showToast(err.message, "error");
            }
            hideSpinner();
        };

        const forgotPasswordBtn = document.getElementById('forgot-password');

        forgotPasswordBtn.onclick = async () => {
            const email = document.getElementById('auth-email').value.trim();
            if (!email) {
                authError.textContent = "Please enter your email above to reset password.";
                showToast("Please enter your email above to reset password.", "error");
                return;
            }
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                authError.textContent = "Password reset email sent! Please check your inbox.";
                authError.classList.remove("text-red-500");
                authError.classList.add("text-green-600");
                showToast("Password reset email sent!", "success");
            } catch (err) {
                authError.textContent = err.message;
                authError.classList.remove("text-green-600");
                authError.classList.add("text-red-500");
                showToast(err.message, "error");
            }
        };

        async function removeFurniture(id) {
            if (confirm("Are you sure you want to remove this furniture?")) {
                await db.collection('furnitures').doc(id).delete();
                fetchFurniture(isAdminGlobal);
            }
        }
        window.removeFurniture = removeFurniture;
        window.showEditModal = showEditModal;

        // Carousel logic
        const slides = document.querySelectorAll('.carousel-slide');
        const dots = document.querySelectorAll('.carousel-dot');
        let currentSlide = 0;
        let carouselInterval = null;

        function showSlide(idx) {
            slides.forEach((slide, i) => {
                slide.style.opacity = i === idx ? '1' : '0';
                slide.style.zIndex = i === idx ? '1' : '0';
                dots[i].classList.toggle('bg-indigo-400', i === idx);
                dots[i].classList.toggle('bg-indigo-200', i !== idx);
            });
            currentSlide = idx;
        }

        function nextSlide() {
            showSlide((currentSlide + 1) % slides.length);
        }
        function prevSlide() {
            showSlide((currentSlide - 1 + slides.length) % slides.length);
        }

        document.getElementById('carousel-next').onclick = () => {
            nextSlide();
            resetCarouselInterval();
        };
        document.getElementById('carousel-prev').onclick = () => {
            prevSlide();
            resetCarouselInterval();
        };
        dots.forEach((dot, idx) => {
            dot.onclick = () => {
                showSlide(idx);
                resetCarouselInterval();
            };
        });

        function startCarouselInterval() {
            carouselInterval = setInterval(nextSlide, 4000);
        }
        function resetCarouselInterval() {
            clearInterval(carouselInterval);
            startCarouselInterval();
        }
        showSlide(0);
        startCarouselInterval();

        // Order modal logic
        const orderModal = document.getElementById('order-modal');
        const orderForm = document.getElementById('order-form');

        // Add this for the cancel button
        document.getElementById('cancel-order').onclick = function () {
            orderModal.classList.add('hidden');
        };

        let currentOrderFurnitureId = null;
        let currentOrderFurnitureName = null;
        let currentOrderStock = null;
        let currentOrderPrice = null;

        function openOrderModal(furnitureId, furnitureName, stock) {
            // Fetch the furniture price from the DOM or Firestore
            const card = Array.from(document.querySelectorAll('#furniture-list > div')).find(div => div.innerHTML.includes(furnitureId));
            let price = 0;
            if (card) {
                // Extract price from the card
                const priceText = card.querySelector('.font-bold.text-indigo-700').textContent;
                price = Number(priceText.replace(/[^\d]/g, ''));
            }
            currentOrderFurnitureId = furnitureId;
            currentOrderFurnitureName = furnitureName;
            currentOrderStock = stock;
            currentOrderPrice = price;
            document.getElementById('order-modal-title').textContent = stock > 0 ? "Book Order" : "Pre-order";
            document.getElementById('order-modal').classList.remove('hidden');
            document.getElementById('order-quantity').value = 1;
            updateAdvanceAmount();
        }
        window.openOrderModal = openOrderModal;

        // Update advance amount when quantity changes
        document.getElementById('order-quantity').addEventListener('input', updateAdvanceAmount);

        function updateAdvanceAmount() {
            const quantity = Number(document.getElementById('order-quantity').value) || 1;
            const advance = Math.round((currentOrderPrice * quantity) * 0.4);
            document.getElementById('advance-amount').textContent = "Nu." + advance;
        }

        document.getElementById('order-form').onsubmit = async function (e) {
            e.preventDefault();
            const fullname = document.getElementById('order-fullname').value;
            const mobile = document.getElementById('order-mobile').value;
            let address = document.getElementById('order-address').value;
            if (address === 'other') {
                address = document.getElementById('order-other-location').value.trim();
                // Check for uncertain delivery locations
                const uncertainPlaces = ["gasa", "tsirang", "tashiyangtse", "bumthang", "trongsa"];
                if (uncertainPlaces.includes(address.toLowerCase())) {
                    alert("Delivery is uncertain for " + address.charAt(0).toUpperCase() + address.slice(1) + ".");
                }
            }
            const quantity = Number(document.getElementById('order-quantity').value);
            const journalNumber = document.getElementById('order-journal').value.trim();
            const user = firebase.auth().currentUser;
            if (!user) {
                alert("Please login to place an order.");
                return;
            }
            if (currentOrderStock > 0 && quantity > currentOrderStock) {
                // alert("Not enough stock available. Please enter a quantity less than or equal to " + currentOrderStock + ".");
                showToast("Not enough stock available.", "error");
                return;
            }
            if (!journalNumber) {
                alert("Please enter the journal number for your advance payment.");
                return;
            }
            await db.collection('bookings').add({
                userId: user.uid,
                furnitureId: currentOrderFurnitureId,
                fullname,
                mobile,
                address,
                quantity,
                journalNumber,
                advanceAmount: Math.round((currentOrderPrice * quantity) * 0.4),
                status: "pending",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // alert("Your order has been placed!");
            showToast("Your order has been placed!", "success");
            document.getElementById('order-modal').classList.add('hidden');
        };

        function toggleOtherLocation(select) {
            const otherInput = document.getElementById('order-other-location');
            if (select.value === 'other') {
                otherInput.classList.remove('hidden');
                otherInput.required = true;
            } else {
                otherInput.classList.add('hidden');
                otherInput.required = false;
            }
        }

        // Hamburger menu toggle
        document.getElementById('nav-toggle').onclick = function () {
            const menu = document.getElementById('nav-menu');
            menu.classList.toggle('hidden');
        };
        // Optional: Hide menu when clicking a link (mobile)
        document.querySelectorAll('#nav-menu a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 640) {
                    document.getElementById('nav-menu').classList.add('hidden');
                }
            });
        });

        function showSpinner() {
            document.getElementById('spinner-overlay').classList.remove('hidden');
        }
        function hideSpinner() {
            document.getElementById('spinner-overlay').classList.add('hidden');
        }

        function showToast(message, type = "success") {
            const toast = document.getElementById('toast');
            const toastContent = document.getElementById('toast-content');
            toastContent.textContent = message;
            toastContent.className = `px-6 py-3 rounded shadow text-white text-center ${type === "success" ? "bg-green-600" : "bg-red-600"}`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Contact form submission (Firestore "contacts" collection)
        const contactForm = document.getElementById('contact-form');
        if (contactForm) {
            contactForm.onsubmit = async function (e) {
                e.preventDefault();
                showSpinner();
                const name = document.getElementById('contact-name').value.trim();
                const email = document.getElementById('contact-email').value.trim();
                const message = document.getElementById('contact-message').value.trim();
                try {
                    await db.collection('contacts').add({
                        name,
                        email,
                        message,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    contactForm.reset();
                    showToast("Message sent! We'll get back to you soon.", "success");
                } catch (err) {
                    showToast("Failed to send message. Please try again.", "error");
                }
                hideSpinner();
            };
        }

        // Admin messages logic
        const messagesSection = document.getElementById('admin-messages');
        const messagesList = document.getElementById('messages-list');

        async function fetchMessages() {
            const snapshot = await db.collection('contacts').orderBy('createdAt', 'desc').get();
            const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMessages(messages);
        }

        function renderMessages(messages) {
            messagesList.innerHTML = '';
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = "bg-white rounded shadow p-4";
                div.innerHTML = `
            <div class="font-semibold text-gray-800">${msg.name} <span class="text-sm text-gray-500">(${msg.email})</span></div>
            <div class="text-gray-700 mt-1">${msg.message}</div>
            <div class="text-xs text-gray-500 mt-2">${msg.createdAt && msg.createdAt.seconds ? new Date(msg.createdAt.seconds * 1000).toLocaleString() : ''}</div>
            <button class="mt-2 bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition" onclick="removeMessage('${msg.id}')">Remove</button>
        `;
                messagesList.appendChild(div);
            });
        }

        // For fetchContactMessages, use the same renderMessages function:
        async function fetchContactMessages() {
            messagesList.innerHTML = '';
            const snapshot = await db.collection('contacts').orderBy('createdAt', 'desc').get();
            if (snapshot.empty) {
                messagesList.innerHTML = '<div class="text-gray-500 text-center">No messages yet.</div>';
                return;
            }
            const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMessages(messages);
        }

        // Show messages section if admin
        firebase.auth().onAuthStateChanged(user => {
            if (user && adminEmails.includes(user.email)) {
                messagesSection.classList.remove('hidden');
                fetchMessages();
                fetchContactMessages();
                // Hide contact form for admin
                document.getElementById('contact-form').parentElement.classList.add('hidden');
            } else {
                messagesSection.classList.add('hidden');
                // Show contact form for non-admins
                document.getElementById('contact-form').parentElement.classList.remove('hidden');
            }
        });

        window.removeMessage = async function (id) {
            if (confirm("Remove this message?")) {
                await db.collection('contacts').doc(id).delete();
                showToast("Message removed.", "success");
                fetchContactMessages();
            }
        };

        const passwordInput = document.getElementById('auth-password');
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');

        passwordInput.addEventListener('input', function () {
            const val = passwordInput.value;
            let score = 0;
            if (val.length >= 8) score++;
            if (/[A-Z]/.test(val)) score++;
            if (/[a-z]/.test(val)) score++;
            if (/[0-9]/.test(val)) score++;
            if (/[^A-Za-z0-9]/.test(val)) score++;

            let width = "0%";
            let color = "bg-red-500";
            let text = "Too weak";
            if (score === 1) { width = "20%"; color = "bg-red-500"; text = "Very weak"; }
            if (score === 2) { width = "40%"; color = "bg-orange-500"; text = "Weak"; }
            if (score === 3) { width = "60%"; color = "bg-yellow-500"; text = "Medium"; }
            if (score === 4) { width = "80%"; color = "bg-blue-500"; text = "Strong"; }
            if (score === 5) { width = "100%"; color = "bg-green-600"; text = "Very strong"; }

            strengthBar.style.width = width;
            strengthBar.className = `h-2 rounded transition-all duration-300 ${color}`;
            strengthText.textContent = text;
        });

        const passwordStrengthDiv = document.getElementById('password-strength');
        const passwordStrengthText = document.getElementById('password-strength-text');

        // Hide by default (since Login is default)
        passwordStrengthDiv.style.display = "none";
        passwordStrengthText.style.display = "none";

        toggleAuth.onclick = () => {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? "Login" : "Sign Up";
            toggleAuth.textContent = isLogin ? "Sign Up" : "Login";
            authSubmit.textContent = isLogin ? "Login" : "Sign Up";
            authError.textContent = "";
            // Show forgot password only in Login mode
            forgotPasswordBtn.classList.toggle('hidden', !isLogin);

            // Show strength meter only in Sign Up mode
            if (isLogin) {
                passwordStrengthDiv.style.display = "none";
                passwordStrengthText.style.display = "none";
            } else {
                passwordStrengthDiv.style.display = "block";
                passwordStrengthText.style.display = "block";
            }
        };

        // Also hide on modal open for Login
        loginBtn.onclick = (e) => {
            e.preventDefault();
            authModal.classList.remove('hidden');
            isLogin = true;
            authTitle.textContent = "Login";
            toggleAuth.textContent = "Sign Up";
            authSubmit.textContent = "Login";
            authError.textContent = "";
            forgotPasswordBtn.classList.remove('hidden');
            passwordStrengthDiv.style.display = "none";
            passwordStrengthText.style.display = "none";
        };

        // Scroll to category
        function scrollToCategory(cat) {
            const el = document.getElementById(`cat-${cat.replace(/\s+/g, '-')}`);
            if (el) {
                // Scroll with offset (e.g., 80px for header)
                const y = el.getBoundingClientRect().top + window.pageYOffset - 80;
                window.scrollTo({ top: y, behavior: 'smooth' });

                // Highlight the heading
                el.classList.add('category-highlight');
                setTimeout(() => {
                    el.classList.remove('category-highlight');
                }, 1000);
            }
        }
        window.scrollToCategory = scrollToCategory;

        function copyAccountNumber() {
            const accNum = document.getElementById('account-number').textContent;
            // Extract only the numbers before any space or '('
            const pureNum = accNum.split(' ')[0];
            navigator.clipboard.writeText(pureNum);
            showToast("Account number copied!", "success");
        }
        window.copyAccountNumber = copyAccountNumber;
    </script>
</body>

</html>